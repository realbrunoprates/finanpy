{% extends 'base.html' %}
{% load currency_filters querystring %}

{% block title %}Transações - Finanpy{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
{% include 'includes/breadcrumbs.html' with breadcrumbs=breadcrumbs %}

<!-- Header Section -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 space-y-4 md:space-y-0">
    <h1 class="text-3xl md:text-4xl font-bold text-text-primary">Transações</h1>
    <a href="{% url 'transactions:create' %}" class="px-6 py-3 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200 shadow-lg hover:shadow-xl text-center" title="Registrar uma nova transação">
        + Nova Transação
    </a>
</div>

<!-- Filters Section -->
<div class="bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary mb-8">
    <h2 class="text-xl font-semibold text-text-primary mb-4">Filtros</h2>
    <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
            <label for="data_inicio" class="block text-text-secondary text-sm font-medium mb-2">
                Data Início
            </label>
            <input
                type="date"
                id="data_inicio"
                name="data_inicio"
                value="{{ filter_data_inicio }}"
                class="w-full px-4 py-3 bg-bg-primary border border-bg-tertiary rounded-lg text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
            >
        </div>

        <div>
            <label for="data_fim" class="block text-text-secondary text-sm font-medium mb-2">
                Data Fim
            </label>
            <input
                type="date"
                id="data_fim"
                name="data_fim"
                value="{{ filter_data_fim }}"
                class="w-full px-4 py-3 bg-bg-primary border border-bg-tertiary rounded-lg text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
            >
        </div>

        <div>
            <label for="conta" class="block text-text-secondary text-sm font-medium mb-2">
                Conta
            </label>
            <select
                id="conta"
                name="conta"
                class="w-full px-4 py-3 bg-bg-primary border border-bg-tertiary rounded-lg text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
            >
                <option value="">Todas as contas</option>
                {% for account in accounts %}
                    <option value="{{ account.id }}" {% if filter_conta == account.id|stringformat:'s' %}selected{% endif %}>
                        {{ account.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="categoria" class="block text-text-secondary text-sm font-medium mb-2">
                Categoria
            </label>
            <select
                id="categoria"
                name="categoria"
                class="w-full px-4 py-3 bg-bg-primary border border-bg-tertiary rounded-lg text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
            >
                <option value="">Todas as categorias</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if filter_categoria == category.id|stringformat:'s' %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="md:col-span-2 lg:col-span-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
            <button type="submit" class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200 shadow-lg hover:shadow-xl">
                Filtrar
            </button>
            <a href="{% url 'transactions:list' %}" class="flex-1 sm:flex-none px-6 py-3 bg-bg-tertiary text-text-primary rounded-lg font-medium hover:bg-bg-primary transition-all duration-200 border border-bg-primary text-center" title="Limpar filtros aplicados">
                Limpar Filtros
            </a>
        </div>
    </form>
</div>

<!-- Statistics Cards Section -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Income Card -->
    <div class="bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-success transition-all duration-200">
        <div class="flex items-center justify-between mb-2">
            <span class="text-text-secondary text-sm font-medium">Total Entradas</span>
            <span class="text-success text-xl">↑</span>
        </div>
        <p class="text-2xl md:text-3xl font-bold text-success">{{ total_income|currency }}</p>
    </div>

    <!-- Total Expense Card -->
    <div class="bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-error transition-all duration-200">
        <div class="flex items-center justify-between mb-2">
            <span class="text-text-secondary text-sm font-medium">Total Saídas</span>
            <span class="text-error text-xl">↓</span>
        </div>
        <p class="text-2xl md:text-3xl font-bold text-error">{{ total_expense|currency }}</p>
    </div>

    <!-- Balance Card -->
    <div class="bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-{% if balance >= 0 %}info{% else %}error{% endif %} transition-all duration-200">
        <div class="flex items-center justify-between mb-2">
            <span class="text-text-secondary text-sm font-medium">Balanço</span>
            <span class="{% if balance >= 0 %}text-info{% else %}text-error{% endif %} text-xl">{% if balance >= 0 %}={% else %}↓{% endif %}</span>
        </div>
        <p class="text-2xl md:text-3xl font-bold {% if balance >= 0 %}text-info{% else %}text-error{% endif %}">{{ balance|currency }}</p>
    </div>
</div>

<!-- Transactions Table -->
{% if page_obj %}
    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between mb-6">
        <p class="text-sm text-text-secondary">
            Exibindo {{ page_obj.object_list|length }} de {{ page_obj.paginator.count }} transações filtradas.
        </p>
        <form method="get" class="flex items-center gap-2 bg-bg-secondary border border-bg-tertiary rounded-lg px-3 py-2">
            <label for="transactions-per-page" class="text-sm text-text-secondary">
                Mostrar
            </label>
            <select
                id="transactions-per-page"
                name="per_page"
                class="bg-transparent text-sm font-semibold text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 rounded-md px-2 py-1"
                onchange="this.form.submit()"
            >
                {% for option in per_page_options %}
                    <option value="{{ option }}" {% if option == current_per_page %}selected{% endif %}>
                        {{ option }}
                    </option>
                {% endfor %}
            </select>
            <span class="text-sm text-text-secondary">por página</span>
            {% for key, value in request.GET.items %}
                {% if key != 'per_page' and key != 'page' %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
        </form>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden lg:block bg-bg-secondary rounded-xl shadow-lg border border-bg-tertiary overflow-x-auto mb-8">
        <table class="w-full min-w-[960px]">
            <thead>
                <tr class="bg-bg-tertiary/60 text-left text-xs font-semibold uppercase tracking-wide text-text-secondary">
                    {% with meta=sorting_metadata.date %}
                    <th class="px-6 py-4"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='date' direction=meta.next_direction page=None %}" class="flex items-center gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Data
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    {% with meta=sorting_metadata.description %}
                    <th class="px-6 py-4"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='description' direction=meta.next_direction page=None %}" class="flex items-center gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Descrição
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    {% with meta=sorting_metadata.account %}
                    <th class="px-6 py-4"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='account' direction=meta.next_direction page=None %}" class="flex items-center gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Conta
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    {% with meta=sorting_metadata.category %}
                    <th class="px-6 py-4"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='category' direction=meta.next_direction page=None %}" class="flex items-center gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Categoria
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    {% with meta=sorting_metadata.type %}
                    <th class="px-6 py-4"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='type' direction=meta.next_direction page=None %}" class="flex items-center gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Tipo
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    {% with meta=sorting_metadata.amount %}
                    <th class="px-6 py-4 text-right"{% if meta.is_active %} aria-sort="{% if meta.current_direction == 'asc' %}ascending{% else %}descending{% endif %}"{% endif %}>
                        <a href="?{% update_query sort='amount' direction=meta.next_direction page=None %}" class="flex items-center justify-end gap-2 group">
                            <span class="text-sm font-semibold text-text-secondary group-hover:text-primary-400 transition-colors duration-200">
                                Valor
                            </span>
                            <span class="text-text-muted group-hover:text-primary-400 transition-colors duration-200">
                                {% if meta.is_active %}
                                    {% if meta.current_direction == 'asc' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    {% endif %}
                                {% else %}
                                    <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l5-5 5 5M7 17l5 5 5-5"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </a>
                    </th>
                    {% endwith %}
                    <th class="px-6 py-4 text-center text-sm font-semibold text-text-secondary">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in page_obj %}
                <tr class="border-t border-bg-tertiary hover:bg-bg-tertiary transition-all duration-150">
                    <td class="px-6 py-4 text-text-primary">{{ transaction.transaction_date|date:'d/m/Y' }}</td>
                    <td class="px-6 py-4 text-text-primary">{{ transaction.description }}</td>
                    <td class="px-6 py-4 text-text-secondary">{{ transaction.account.name }}</td>
                    <td class="px-6 py-4 text-text-secondary">{{ transaction.category.name }}</td>
                    <td class="px-6 py-4">
                        {% if transaction.transaction_type == 'income' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20" title="Transação de entrada">
                                Entrada
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-error/10 text-error border border-error/20" title="Transação de saída">
                                Saída
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right font-semibold {% if transaction.transaction_type == 'income' %}text-success{% else %}text-error{% endif %}">
                        {{ transaction.amount|currency }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-center gap-2">
                            <a href="{% url 'transactions:update' transaction.id %}" class="px-4 py-2 bg-bg-primary text-text-primary rounded-lg text-sm font-medium border border-bg-tertiary hover:border-primary-500 hover:text-primary-400 transition-all duration-200" title="Editar transação {{ transaction.description }}">
                                Editar
                            </a>
                            <a href="{% url 'transactions:delete' transaction.id %}" class="px-4 py-2 bg-error/10 text-error rounded-lg text-sm font-medium border border-error/20 hover:bg-error hover:text-white transition-all duration-200" data-confirm="Tem certeza que deseja excluir a transação {{ transaction.description|default:'sem descrição' }}?" title="Excluir transação {{ transaction.description|default:'sem descrição' }}">
                                Excluir
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-text-muted">
                        Nenhuma transação encontrada.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div class="lg:hidden space-y-4 mb-8">
        {% for transaction in page_obj %}
        <div class="bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-text-primary mb-1">{{ transaction.description }}</h3>
                    <p class="text-text-muted text-sm">{{ transaction.transaction_date|date:'d/m/Y' }}</p>
                </div>
                <div class="text-right">
                    <p class="text-xl font-bold {% if transaction.transaction_type == 'income' %}text-success{% else %}text-error{% endif %}">
                        {{ transaction.amount|currency }}
                    </p>
                    {% if transaction.transaction_type == 'income' %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20 mt-1" title="Transação de entrada">
                            Entrada
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-error/10 text-error border border-error/20 mt-1" title="Transação de saída">
                            Saída
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="space-y-2 mb-4 pb-4 border-b border-bg-tertiary">
                <div class="flex items-center justify-between">
                    <span class="text-text-muted text-sm">Conta:</span>
                    <span class="text-text-primary text-sm font-medium">{{ transaction.account.name }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-text-muted text-sm">Categoria:</span>
                    <span class="text-text-primary text-sm font-medium">{{ transaction.category.name }}</span>
                </div>
            </div>

            <div class="flex space-x-2">
                <a href="{% url 'transactions:update' transaction.id %}" class="flex-1 px-4 py-2 bg-bg-primary text-text-primary rounded-lg text-sm font-medium hover:bg-bg-tertiary transition-all duration-200 border border-bg-tertiary text-center" title="Editar transação {{ transaction.description }}">
                    Editar
                </a>
                <a href="{% url 'transactions:delete' transaction.id %}" class="flex-1 px-4 py-2 bg-error/10 text-error rounded-lg text-sm font-medium hover:bg-error hover:text-white transition-all duration-200 border border-error/20 text-center" data-confirm="Tem certeza que deseja excluir a transação {{ transaction.description|default:'sem descrição' }}?" title="Excluir transação {{ transaction.description|default:'sem descrição' }}">
                    Excluir
                </a>
            </div>
        </div>
        {% empty %}
        <div class="bg-bg-secondary rounded-xl p-12 text-center border border-bg-tertiary">
            <p class="text-text-muted text-lg mb-4">Nenhuma transação encontrada.</p>
            <a href="{% url 'transactions:create' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200" title="Registrar a primeira transação">
                Criar Primeira Transação
            </a>
        </div>
        {% endfor %}
    </div>

    {% include 'includes/pagination.html' with page_obj=page_obj %}
{% else %}
    <!-- Empty State -->
    <div class="bg-bg-secondary rounded-xl p-12 text-center border border-bg-tertiary">
        <p class="text-text-muted text-lg mb-4">Nenhuma transação cadastrada.</p>
        <a href="{% url 'transactions:create' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200">
            Criar Primeira Transação
        </a>
    </div>
{% endif %}
{% endblock %}
