{% extends 'base.html' %}
{% load currency_filters %}

{% block title %}Dashboard - Finanpy{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class='mb-8'>
    <h1 class='text-3xl md:text-4xl font-bold text-text-primary mb-2'>
        Dashboard
    </h1>
    <p class='text-text-secondary text-lg'>
        Bem-vindo,
        <span class='text-text-primary font-semibold'>
            {% if user.profile and user.profile.full_name %}
                {{ user.profile.full_name }}
            {% else %}
                {{ user.email }}
            {% endif %}
        </span>!
    </p>
</div>

<!-- Statistics Grid - 4 Main Cards -->
<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8'>
    <!-- Card 1: Total Balance (Gradient) -->
    <div class='bg-gradient-to-br from-primary-500 to-accent-500 rounded-xl p-6 shadow-xl'>
        <div class='flex items-center justify-between mb-2'>
            <h3 class='text-lg font-semibold text-white/90'>Saldo Total</h3>
            <svg class='w-8 h-8 text-white/80' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/>
            </svg>
        </div>
        <p class='text-3xl md:text-4xl font-bold text-white mb-1'>
            {{ total_balance|default:0|currency }}
        </p>
        <p class='text-white/80 text-sm'>
            {{ active_accounts_count }} conta{{ active_accounts_count|pluralize }}
        </p>
    </div>

    <!-- Card 2: Monthly Income (Green) -->
    <div class='bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-success transition-all duration-200'>
        <div class='flex items-center justify-between mb-2'>
            <h3 class='text-sm font-medium text-text-secondary'>Entradas do Mês</h3>
            <span class='text-success text-2xl'>↑</span>
        </div>
        <p class='text-2xl md:text-3xl font-bold text-success mb-1'>
            {{ total_income_month|default:0|currency }}
        </p>
        <p class='text-text-muted text-xs'>
            {{ current_month }}
        </p>
    </div>

    <!-- Card 3: Monthly Expenses (Red) -->
    <div class='bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-error transition-all duration-200'>
        <div class='flex items-center justify-between mb-2'>
            <h3 class='text-sm font-medium text-text-secondary'>Saídas do Mês</h3>
            <span class='text-error text-2xl'>↓</span>
        </div>
        <p class='text-2xl md:text-3xl font-bold text-error mb-1'>
            {{ total_expenses_month|default:0|currency }}
        </p>
        <p class='text-text-muted text-xs'>
            {{ current_month }}
        </p>
    </div>

    <!-- Card 4: Monthly Balance (Blue if positive, Red if negative) -->
    <div class='bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary hover:border-{% if month_balance >= 0 %}info{% else %}error{% endif %} transition-all duration-200'>
        <div class='flex items-center justify-between mb-2'>
            <h3 class='text-sm font-medium text-text-secondary'>Balanço do Mês</h3>
            <span class='{% if month_balance >= 0 %}text-info{% else %}text-error{% endif %} text-2xl'>
                {% if month_balance >= 0 %}={% else %}↓{% endif %}
            </span>
        </div>
        <p class='text-2xl md:text-3xl font-bold {% if month_balance >= 0 %}text-info{% else %}text-error{% endif %} mb-1'>
            {{ month_balance|currency }}
        </p>
        <p class='text-text-muted text-xs'>
            Entradas - Saídas
        </p>
    </div>
</div>

<!-- Quick Actions Section -->
<div class='mb-8'>
    <h2 class='text-2xl font-bold text-text-primary mb-4'>Ações Rápidas</h2>
    <div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4'>
        <!-- New Transaction Button -->
        <a href='{% url 'transactions:create' %}' class='flex items-center gap-4 p-4 bg-bg-secondary rounded-lg border border-bg-tertiary hover:border-primary-500 transition-all duration-200 group shadow-lg hover:-translate-y-1' title='Registrar uma nova transação'>
            <div class='w-12 h-12 bg-gradient-to-r from-primary-500 to-accent-500 rounded-lg flex items-center justify-center flex-shrink-0'>
                <svg class='w-6 h-6 text-white' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 6v6m0 0v6m0-6h6m-6 0H6'/>
                </svg>
            </div>
            <div class='flex-1'>
                <h4 class='text-text-primary font-semibold group-hover:text-primary-500 transition-colors duration-200'>
                    Nova Transação
                </h4>
                <p class='text-text-muted text-sm'>
                    Registrar entrada ou saída
                </p>
            </div>
        </a>

        <!-- New Account Button -->
        <a href='{% url 'accounts:create' %}' class='flex items-center gap-4 p-4 bg-bg-secondary rounded-lg border border-bg-tertiary hover:border-primary-500 transition-all duration-200 group shadow-lg hover:-translate-y-1' title='Adicionar uma nova conta'>
            <div class='w-12 h-12 bg-gradient-to-r from-primary-500 to-accent-500 rounded-lg flex items-center justify-center flex-shrink-0'>
                <svg class='w-6 h-6 text-white' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/>
                </svg>
            </div>
            <div class='flex-1'>
                <h4 class='text-text-primary font-semibold group-hover:text-primary-500 transition-colors duration-200'>
                    Nova Conta
                </h4>
                <p class='text-text-muted text-sm'>
                    Adicionar conta bancária
                </p>
            </div>
        </a>

        <!-- New Category Button -->
        <a href='{% url 'categories:category_create' %}' class='flex items-center gap-4 p-4 bg-bg-secondary rounded-lg border border-bg-tertiary hover:border-primary-500 transition-all duration-200 group shadow-lg hover:-translate-y-1' title='Criar uma nova categoria personalizada'>
            <div class='w-12 h-12 bg-gradient-to-r from-primary-500 to-accent-500 rounded-lg flex items-center justify-center flex-shrink-0'>
                <svg class='w-6 h-6 text-white' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'/>
                </svg>
            </div>
            <div class='flex-1'>
                <h4 class='text-text-primary font-semibold group-hover:text-primary-500 transition-colors duration-200'>
                    Nova Categoria
                </h4>
                <p class='text-text-muted text-sm'>
                    Criar categoria personalizada
                </p>
            </div>
        </a>
    </div>
</div>

<!-- Two Columns Section: Recent Transactions + Expenses by Category -->
<div class='grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8'>
    <!-- Recent Transactions Section -->
    <div class='bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary'>
        <div class='flex items-center justify-between mb-6'>
            <h2 class='text-2xl font-bold text-text-primary'>Transações Recentes</h2>
            <a href='{% url 'transactions:list' %}' class='text-primary-500 hover:text-primary-600 text-sm font-medium transition-colors duration-200'>
                Ver Todas →
            </a>
        </div>

        {% if recent_transactions %}
            <!-- Desktop Table View -->
            <div class='hidden md:block overflow-x-auto'>
                <table class='w-full'>
                    <thead>
                        <tr class='border-b border-bg-tertiary'>
                            <th class='px-4 py-3 text-left text-text-secondary text-xs font-semibold'>Data</th>
                            <th class='px-4 py-3 text-left text-text-secondary text-xs font-semibold'>Descrição</th>
                            <th class='px-4 py-3 text-left text-text-secondary text-xs font-semibold'>Conta</th>
                            <th class='px-4 py-3 text-right text-text-secondary text-xs font-semibold'>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in recent_transactions %}
                        <tr class='border-b border-bg-tertiary hover:bg-bg-tertiary transition-all duration-150'>
                            <td class='px-4 py-3 text-text-secondary text-sm'>
                                {{ transaction.transaction_date|date:'d/m' }}
                            </td>
                            <td class='px-4 py-3 text-text-primary text-sm'>
                                {{ transaction.description|truncatechars:25 }}
                            </td>
                            <td class='px-4 py-3 text-text-secondary text-sm'>
                                {{ transaction.account.name|truncatechars:15 }}
                            </td>
                            <td class='px-4 py-3 text-right text-sm font-semibold {% if transaction.transaction_type == 'income' %}text-success{% else %}text-error{% endif %}'>
                                {% if transaction.transaction_type == 'income' %}+{% endif %}{{ transaction.amount|currency }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class='md:hidden space-y-3'>
                {% for transaction in recent_transactions %}
                <div class='p-4 bg-bg-primary rounded-lg border border-bg-tertiary'>
                    <div class='flex items-start justify-between mb-2'>
                        <div class='flex-1'>
                            <p class='text-text-primary font-medium text-sm'>{{ transaction.description|truncatechars:30 }}</p>
                            <p class='text-text-muted text-xs'>{{ transaction.transaction_date|date:'d/m/Y' }} • {{ transaction.account.name }}</p>
                        </div>
                        <p class='text-sm font-bold {% if transaction.transaction_type == 'income' %}text-success{% else %}text-error{% endif %}'>
                            {% if transaction.transaction_type == 'income' %}+{% endif %}{{ transaction.amount|currency }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class='text-center py-8'>
                <svg class='w-16 h-16 text-text-muted mx-auto mb-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2'/>
                </svg>
                <p class='text-text-muted mb-4'>Nenhuma transação registrada</p>
                <a href='{% url 'transactions:create' %}' class='inline-block px-4 py-2 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg text-sm font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200'>
                    Criar Primeira Transação
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Expenses by Category Section -->
    <div class='bg-bg-secondary rounded-xl p-6 shadow-lg border border-bg-tertiary'>
        <div class='flex items-center justify-between mb-6'>
            <h2 class='text-2xl font-bold text-text-primary'>Gastos por Categoria</h2>
            <span class='text-text-muted text-sm'>{{ current_month }}</span>
        </div>

        {% if expenses_by_category %}
            {% with max_value=expenses_by_category.0.total %}
            <div class='space-y-4'>
                {% for category in expenses_by_category|slice:':5' %}
                <div>
                    <div class='flex items-center justify-between mb-2'>
                        <div class='flex items-center gap-2 flex-1'>
                            <div class='w-3 h-3 rounded-full flex-shrink-0' style='background-color: {{ category.category__color }}'></div>
                            <span class='text-text-primary text-sm font-medium truncate'>
                                {{ category.category__name }}
                            </span>
                        </div>
                        <span class='text-text-primary text-sm font-bold ml-2'>
                            {{ category.total|currency }}
                        </span>
                    </div>
                    <div class='w-full bg-bg-primary rounded-full h-2 overflow-hidden'>
                        {% widthratio category.total max_value 100 as percentage %}
                        <div class='h-full rounded-full transition-all duration-300' style='width: {{ percentage }}%; background-color: {{ category.category__color }}'></div>
                    </div>
                    <p class='text-text-muted text-xs mt-1'>{{ percentage }}% do total</p>
                </div>
                {% endfor %}
            </div>
            {% endwith %}

            {% if expenses_by_category|length > 5 %}
            <div class='mt-4 pt-4 border-t border-bg-tertiary'>
                <a href='{% url 'transactions:list' %}' class='text-primary-500 hover:text-primary-600 text-sm font-medium transition-colors duration-200'>
                    Ver todas as categorias →
                </a>
            </div>
            {% endif %}
        {% else %}
            <div class='text-center py-8'>
                <svg class='w-16 h-16 text-text-muted mx-auto mb-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z'/>
                </svg>
                <p class='text-text-muted mb-4'>Nenhum gasto registrado este mês</p>
                <a href='{% url 'transactions:create' %}' class='inline-block px-4 py-2 bg-gradient-to-r from-primary-500 to-accent-500 text-white rounded-lg text-sm font-medium hover:from-primary-600 hover:to-accent-600 transition-all duration-200'>
                    Registrar Gasto
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
